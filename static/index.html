<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üìö Biblioteca</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { padding: 30px; }
  /* Esconde a √°rea da biblioteca at√© o login */
  .biblioteca-section { display: none; }
</style>
</head>

<body>
<div class="container">

  <!-- ===================== LOGIN ===================== -->
  <h3>Login</h3>
  <div class="row g-2 mb-3">
    <div class="col-md-4">
      <input id="loginUser" class="form-control" placeholder="Usu√°rio">
    </div>
    <div class="col-md-4">
      <input id="loginSenha" type="password" class="form-control" placeholder="Senha">
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" onclick="login()">Entrar</button>
    </div>
    <div class="col-md-2">
      <button class="btn btn-secondary w-100" onclick="logout()">Sair</button>
    </div>
  </div>
  <p id="loginMsg"></p>

  <!-- ===================== √ÅREA DA BIBLIOTECA ===================== -->
  <div class="biblioteca-section">
    <h1>üìö Biblioteca</h1>

    <div class="mb-3">
      <input type="text" id="busca" class="form-control" placeholder="Buscar por t√≠tulo...">
    </div>

    <button class="btn btn-primary mb-3" onclick="buscar()">üîç Buscar</button>
    <button class="btn btn-secondary mb-3" onclick="carregar()">Mostrar Todos</button>

    <table class="table table-bordered">
      <thead>
        <tr><th>ID</th><th>T√≠tulo</th><th>Autor</th><th>Ano</th><th>A√ß√µes</th></tr>
      </thead>
      <tbody id="tabelaLivros"></tbody>
    </table>

    <h3>Adicionar Livro</h3>
    <div class="row g-2">
      <div class="col-md-4"><input id="titulo" class="form-control" placeholder="T√≠tulo"></div>
      <div class="col-md-4"><input id="autor" class="form-control" placeholder="Autor"></div>
      <div class="col-md-2"><input id="ano" class="form-control" type="number" placeholder="Ano"></div>
      <div class="col-md-2"><button class="btn btn-success w-100" onclick="adicionar()">Adicionar</button></div>
    </div>
  </div>
</div>

<script>
const api = '/api/livros';

// ---- LOGIN ----
async function login() {
  const usuario = document.getElementById('loginUser').value.trim();
  const senha = document.getElementById('loginSenha').value.trim();
  const msg = document.getElementById('loginMsg');

  if (!usuario || !senha) {
    msg.textContent = "‚ö†Ô∏è Digite usu√°rio e senha.";
    msg.style.color = "orange";
    return;
  }

  const res = await fetch('/login', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({usuario, senha})
  });

  if (res.ok) {
    msg.textContent = "‚úÖ Login realizado com sucesso!";
    msg.style.color = "green";
    mostrarBiblioteca(true);
    carregar();
  } else {
    const data = await res.json();
    msg.textContent = "‚ùå " + (data.erro || "Erro no login");
    msg.style.color = "red";
    mostrarBiblioteca(false);
  }
}

// ---- LOGOUT ----
async function logout() {
  await fetch('/logout');
  document.getElementById('loginMsg').textContent = "Sess√£o encerrada.";
  document.getElementById('loginMsg').style.color = "gray";
  document.getElementById('tabelaLivros').innerHTML = "";
  mostrarBiblioteca(false);
}

// ---- Mostrar / esconder √°rea da biblioteca ----
function mostrarBiblioteca(mostrar) {
  document.querySelector('.biblioteca-section').style.display = mostrar ? 'block' : 'none';
}

// ---- Carregar todos os livros ----
async function carregar() {
  try {
    const res = await fetch(api);
    if (res.status === 403) {
      mostrarBiblioteca(false);
      document.getElementById('loginMsg').textContent = "‚ö†Ô∏è Fa√ßa login para acessar os livros.";
      document.getElementById('loginMsg').style.color = "orange";
      return;
    }
    if (!res.ok) throw new Error('Erro ao buscar livros');
    const livros = await res.json();
    preencherTabela(livros);
  } catch (e) {
    alert(e);
    console.error(e);
  }
}

// ---- Buscar livros pelo t√≠tulo ----
async function buscar() {
  const busca = document.getElementById('busca').value;
  try {
    const res = await fetch(api + '?busca=' + encodeURIComponent(busca));
    if (!res.ok) throw new Error('Erro ao buscar livros');
    const livros = await res.json();
    preencherTabela(livros);
  } catch (e) {
    alert(e);
    console.error(e);
  }
}

// ---- Adicionar livro ----
async function adicionar() {
  const titulo = document.getElementById('titulo').value.trim();
  const autor = document.getElementById('autor').value.trim();
  const ano = parseInt(document.getElementById('ano').value) || null;

  if (!titulo) return alert('Digite um t√≠tulo!');

  try {
    const res = await fetch(api, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({titulo, autor, ano})
    });
    if (res.status === 403) {
      alert("Voc√™ precisa fazer login para adicionar livros.");
      return;
    }
    if (!res.ok) throw new Error('Erro ao adicionar livro');
    alert('üìñ Livro adicionado!');
    document.getElementById('titulo').value = '';
    document.getElementById('autor').value = '';
    document.getElementById('ano').value = '';
    carregar();
  } catch (e) {
    alert(e);
    console.error(e);
  }
}

// ---- Excluir livro ----
async function excluir(id) {
  if (!confirm('Tem certeza que deseja excluir este livro?')) return;
  try {
    const res = await fetch(api + '/' + id, { method: 'DELETE' });
    if (res.status === 403) {
      alert("Voc√™ precisa fazer login para excluir livros.");
      return;
    }
    if (!res.ok) throw new Error('Erro ao excluir livro');
    alert('üóëÔ∏è Livro removido!');
    carregar();
  } catch (e) {
    alert(e);
    console.error(e);
  }
}

// ---- Preencher a tabela HTML ----
function preencherTabela(livros) {
  const tbody = document.getElementById('tabelaLivros');
  tbody.innerHTML = '';
  livros.forEach(l => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${l.id}</td>
      <td>${l.titulo}</td>
      <td>${l.autor || ''}</td>
      <td>${l.ano || ''}</td>
      <td><button class="btn btn-danger btn-sm" onclick="excluir(${l.id})">Excluir</button></td>
    `;
    tbody.appendChild(tr);
  });
}
</script>
</body>
</html>
